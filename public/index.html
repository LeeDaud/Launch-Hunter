<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Virtuals Sniping Decision Console</title>
    <style>
      :root {
        --bg: #070f1a;
        --card: #111f33;
        --card2: #13263d;
        --text: #e6f0ff;
        --muted: #8ea5bf;
        --accent: #65c2ff;
        --ok: #4ed78d;
        --warn: #f0c156;
        --wait: #7d8b9a;
        --danger: #ff5e78;
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        color: var(--text);
        font-family: Segoe UI, Arial, sans-serif;
        background: radial-gradient(1200px 500px at 15% -20%, #1a3d60 0%, #0d1a2a 45%, var(--bg) 100%);
      }
      .wrap { max-width: 1400px; margin: 0 auto; padding: 16px; }
      .card {
        background: linear-gradient(180deg, rgba(20,40,62,.92), rgba(15,30,48,.92));
        border-radius: 12px;
        padding: 12px;
        box-shadow: 0 8px 24px rgba(0,0,0,.22);
      }
      .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
      .input {
        background: #0b1523;
        border: none;
        border-radius: 8px;
        color: var(--text);
        padding: 10px 12px;
        outline: 1px solid rgba(123, 164, 205, .2);
      }
      .mono { font-family: ui-monospace, Menlo, Consolas, monospace; }
      .grow { flex: 1; min-width: 280px; }
      .btn {
        border: none;
        border-radius: 8px;
        padding: 10px 12px;
        background: #1f4163;
        color: var(--text);
        cursor: pointer;
      }
      .btn.active { outline: 2px solid rgba(101,194,255,.8); }
      .status {
        margin-top: 8px;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
      }
      .pill {
        background: rgba(101,194,255,.12);
        color: #c8e8ff;
        border-radius: 8px;
        padding: 8px 10px;
      }

      .hero {
        margin-top: 10px;
        display: grid;
        grid-template-columns: 1fr 1.2fr .8fr;
        gap: 10px;
      }

      .kpis {
        display: grid;
        grid-template-columns: repeat(2, minmax(120px, 1fr));
        gap: 8px;
      }
      .kpi { background: rgba(12,24,38,.8); border-radius: 8px; padding: 8px; }
      .kpi .k { font-size: 12px; color: var(--muted); }
      .kpi .v { margin-top: 3px; font-size: 18px; font-weight: 700; }

      .rule-title { font-size: 12px; color: #bbddff; }
      .rule-state { margin-top: 6px; font-size: 24px; font-weight: 800; letter-spacing: .4px; }
      .s-wait { color: var(--wait); }
      .s-first { color: var(--warn); }
      .s-second { color: var(--ok); }
      .s-trigger { color: var(--danger); }
      .blink { animation: blink 1s infinite; }
      @keyframes blink { 0% { opacity:.4; } 50% { opacity:1; } 100% { opacity:.4; } }

      .bars { margin-top: 8px; height: 72px; display: grid; grid-template-columns: repeat(10,1fr); gap: 6px; align-items: end; }
      .bar { background: linear-gradient(180deg, #86d4ff, #3f7fb8); border-radius: 4px 4px 2px 2px; min-height: 4px; }

      .curve-wrap { height: 240px; margin-top: 8px; background: rgba(12,24,38,.7); border-radius: 10px; padding: 8px; }
      .curve-legend { display: flex; gap: 16px; font-size: 12px; color: var(--muted); }
      .dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 5px; }

      .panel-grid { margin-top: 10px; display: grid; grid-template-columns: 1.2fr .8fr; gap: 10px; }
      .table-wrap { max-height: 52vh; overflow: auto; }
      table { width: 100%; border-collapse: collapse; font-size: 12px; }
      th, td { padding: 8px 6px; text-align: left; }
      th { color: #abd3ef; }
      tbody tr { border-top: 1px solid rgba(130,160,190,.14); }
      .good { color: var(--ok); }
      .bad { color: #ff8da0; }

      @media (max-width: 1100px) {
        .hero { grid-template-columns: 1fr; }
        .panel-grid { grid-template-columns: 1fr; }
        .status { grid-template-columns: 1fr; }
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="card">
        <div class="row">
          <input id="tokenInput" class="input grow mono" placeholder="Token CA (0x...)" />
          <input id="launchInput" class="input mono" style="width:170px" placeholder="Launch TS(sec)" />
          <input id="walletInput" class="input mono" style="width:220px" placeholder="My Wallet (0x...)" />
          <input id="sellTaxInput" class="input mono" style="width:110px" placeholder="SellTax %" value="1" />
          <button id="startBtn" class="btn">开始追踪</button>
          <button id="stopBtn" class="btn">停止</button>
          <button id="modeToken" class="btn active" data-mode="token_received">口径 Token</button>
          <button id="modeVirtual" class="btn" data-mode="virtual_spent">口径 Virtual</button>
        </div>
        <div class="status">
          <div id="tokenPill" class="pill mono">Token: -</div>
          <div id="statusPill" class="pill mono">Status: stopped | Block: -</div>
        </div>
      </div>

      <div class="hero">
        <div class="card">
          <div class="rule-title">规则状态</div>
          <div id="ruleState" class="rule-state s-wait">等待中</div>
          <div id="ruleDesc" style="font-size:12px;color:#9fb8ce;margin-top:5px;">等待连续两分钟突破 3000 / 6000</div>
          <div id="taxNow" style="margin-top:8px;font-size:13px;color:#c7e6ff;">当前买入税率: 1%</div>
          <div id="pairNow" class="mono" style="margin-top:4px;font-size:12px;color:#aac7dd;">Pair: -</div>
          <div class="bars" id="bars"></div>
        </div>

        <div class="card">
          <div class="curve-legend">
            <span><i class="dot" style="background:#67c4ff"></i>EMV</span>
            <span><i class="dot" style="background:#f8b24f"></i>RMV</span>
          </div>
          <div class="curve-wrap">
            <svg id="curveSvg" viewBox="0 0 1000 240" width="100%" height="100%"></svg>
          </div>
        </div>

        <div class="card">
          <div class="kpis">
            <div class="kpi"><div class="k">1m Taxed Vol</div><div id="kpi1" class="v">0</div></div>
            <div class="kpi"><div class="k">2m Seq</div><div id="kpi2" class="v">0</div></div>
            <div class="kpi"><div class="k">5m Taxed Vol</div><div id="kpi5" class="v">0</div></div>
            <div class="kpi"><div class="k">Cooldown</div><div id="kpiCd" class="v">Ready</div></div>
            <div class="kpi"><div class="k">My RMV</div><div id="kpiRmv" class="v">0</div></div>
            <div class="kpi"><div class="k">My Cost</div><div id="kpiCost" class="v">0</div></div>
          </div>
        </div>
      </div>

      <div class="panel-grid">
        <div class="card">
          <div style="font-size:13px;color:#c3e5ff;margin-bottom:6px;">Holders</div>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>Address</th>
                  <th>Balance</th>
                  <th>Cum In</th>
                  <th>Cum Out</th>
                  <th>Share%</th>
                  <th>Δ5m</th>
                  <th>Cost</th>
                  <th>BE MCAP</th>
                </tr>
              </thead>
              <tbody id="holderBody"></tbody>
            </table>
          </div>
        </div>

        <div class="card">
          <div style="font-size:13px;color:#c3e5ff;margin-bottom:6px;">Special Protocol Flows</div>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>Label</th>
                  <th>Category</th>
                  <th>5m V</th>
                  <th>1h V</th>
                  <th>Cum V</th>
                  <th>5m T</th>
                  <th>Cum T</th>
                </tr>
              </thead>
              <tbody id="specialBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <script>
      const $ = (id) => document.getElementById(id);
      const tokenInput = $('tokenInput');
      const launchInput = $('launchInput');
      const walletInput = $('walletInput');
      const sellTaxInput = $('sellTaxInput');
      const tokenPill = $('tokenPill');
      const statusPill = $('statusPill');
      const ruleState = $('ruleState');
      const ruleDesc = $('ruleDesc');
      const taxNow = $('taxNow');
      const pairNow = $('pairNow');
      const bars = $('bars');
      const curveSvg = $('curveSvg');
      const holderBody = $('holderBody');
      const specialBody = $('specialBody');
      const kpi1 = $('kpi1');
      const kpi2 = $('kpi2');
      const kpi5 = $('kpi5');
      const kpiCd = $('kpiCd');
      const kpiRmv = $('kpiRmv');
      const kpiCost = $('kpiCost');

      let latest = null;
      let flashUntil = 0;

      function shortAddr(v) {
        if (!v) return '-';
        return `${v.slice(0, 6)}...${v.slice(-4)}`;
      }

      function fmt(n) {
        const v = Number(n || 0);
        const sign = v < 0 ? '-' : '';
        const x = Math.abs(v);
        const pick = (d) => (x >= 100 ? d.toFixed(1) : x >= 10 ? d.toFixed(2) : d.toFixed(3));
        if (x >= 1e12) return `${sign}${pick(x / 1e12)}T`;
        if (x >= 1e9) return `${sign}${pick(x / 1e9)}B`;
        if (x >= 1e6) return `${sign}${pick(x / 1e6)}M`;
        if (x >= 1e3) return `${sign}${pick(x / 1e3)}K`;
        if (x >= 1) return `${sign}${x.toFixed(2)}`;
        return `${sign}${x.toFixed(4)}`;
      }

      function setModeBtn(mode) {
        $('modeToken').classList.toggle('active', mode === 'token_received');
        $('modeVirtual').classList.toggle('active', mode === 'virtual_spent');
      }

      function renderBars(series) {
        const d = (series || []).slice(-10);
        const max = Math.max(1, ...d.map((x) => Number(x.value || 0)));
        bars.innerHTML = d.map((x) => {
          const h = Math.max(4, Math.round((Number(x.value || 0) / max) * 64));
          return `<div class="bar" style="height:${h}px" title="${fmt(x.value)}"></div>`;
        }).join('');
      }

      function renderCurve(curves) {
        const emv = curves?.emvSeries || [];
        const rmv = curves?.rmvSeries || [];
        const n = Math.max(emv.length, rmv.length);
        if (!n) {
          curveSvg.innerHTML = '';
          return;
        }

        const emvVals = emv.map((x) => Number(x.value || 0));
        const rmvVals = rmv.map((x) => Number(x.value || 0));
        const all = [...emvVals, ...rmvVals].filter((x) => Number.isFinite(x));
        const max = Math.max(1, ...all);
        const min = Math.min(0, ...all);
        const h = 220;

        const px = (i) => (i / Math.max(1, n - 1)) * 980 + 10;
        const py = (v) => {
          const ratio = (v - min) / Math.max(1e-9, max - min);
          return h - ratio * 200 + 10;
        };

        const emvPts = emvVals.map((v, i) => `${px(i)},${py(v)}`).join(' ');
        const rmvPts = rmvVals.map((v, i) => `${px(i)},${py(v)}`).join(' ');

        curveSvg.innerHTML = `
          <polyline points="${emvPts}" fill="none" stroke="#67c4ff" stroke-width="3" />
          <polyline points="${rmvPts}" fill="none" stroke="#f8b24f" stroke-width="2.5" stroke-dasharray="5 3" />
          <text x="12" y="18" fill="#9fc2df" font-size="12">max ${fmt(max)}</text>
          <text x="12" y="232" fill="#9fc2df" font-size="12">min ${fmt(min)}</text>
        `;
      }

      function renderHolders(snapshot) {
        const rows = (snapshot.holder_stats || []).slice().sort((a, b) => Number(b.balance || 0) - Number(a.balance || 0)).slice(0, 120);
        holderBody.innerHTML = rows.map((r) => {
          const delta = Number(r.delta_5m_token || 0);
          const cls = delta >= 0 ? 'good' : 'bad';
          return `
            <tr>
              <td class="mono" title="${r.address}">${shortAddr(r.address)}</td>
              <td>${fmt(r.balance)}</td>
              <td>${fmt(r.cumulative_in)}</td>
              <td>${fmt(r.cumulative_out)}</td>
              <td>${Number(r.share_pct || 0).toFixed(2)}%</td>
              <td class="${cls}">${fmt(delta)}</td>
              <td>${fmt(r.cost_per_token)}</td>
              <td>${fmt(r.breakeven_mcap)}</td>
            </tr>
          `;
        }).join('');
      }

      function renderSpecial(snapshot) {
        const rows = snapshot.special_stats || [];
        specialBody.innerHTML = rows.map((r) => {
          const c = Number(r.net_virtual_5m || 0) >= 0 ? 'good' : 'bad';
          return `
            <tr>
              <td>${r.label}</td>
              <td>${r.category}</td>
              <td class="${c}">${fmt(r.net_virtual_5m)}</td>
              <td>${fmt(r.net_virtual_1h)}</td>
              <td>${fmt(r.net_virtual_cum)}</td>
              <td>${fmt(r.net_token_5m)}</td>
              <td>${fmt(r.net_token_cum)}</td>
            </tr>
          `;
        }).join('');
      }

      function renderRule(snapshot) {
        const sig = snapshot.signal_state || {};
        const pair = sig.pair || {};
        const v0 = Number(pair.v0 || 0);
        const v1 = Number(pair.v1 || 0);

        ruleState.className = 'rule-state';
        let text = '等待';
        let desc = '等待连续两分钟突破 3000 / 6000';

        if (sig.passed_now) {
          text = '入场触发';
          desc = '规则已触发，进入冷却期';
          ruleState.classList.add('s-trigger');
        } else if (v0 > 3000 && v1 > 6000) {
          text = '第二阈值确认';
          desc = '连续两分钟突破成立';
          ruleState.classList.add('s-second');
        } else if (v0 > 3000) {
          text = '第一阈值突破';
          desc = '等待第二分钟确认';
          ruleState.classList.add('s-first');
        } else {
          ruleState.classList.add('s-wait');
        }

        if (Date.now() < flashUntil) ruleState.classList.add('blink');
        ruleState.textContent = text;
        ruleDesc.textContent = desc;
        pairNow.textContent = `Pair: ${fmt(v0)} -> ${fmt(v1)}`;
      }

      function renderSnapshot(snapshot) {
        if (!snapshot) return;
        latest = snapshot;

        tokenPill.textContent = `Token: ${shortAddr(snapshot.token)}`;
        statusPill.textContent = `Status: ${snapshot.running ? 'running' : 'stopped'} | Block: ${snapshot.last_processed_block || '-'}`;
        setModeBtn(snapshot.metric_mode);

        const w = snapshot.windows || {};
        kpi1.textContent = fmt(w.near_1m);
        kpi2.textContent = `${fmt(w.near_2m_sequence?.[0]?.value || 0)} -> ${fmt(w.near_2m_sequence?.[1]?.value || 0)}`;
        kpi5.textContent = fmt(w.near_5m);
        kpiCd.textContent = snapshot.signal_state?.cooling_down
          ? new Date(Number(snapshot.signal_state.cooldown_until || 0) * 1000).toLocaleTimeString()
          : 'Ready';

        taxNow.textContent = `当前买入税率: ${Number(snapshot.tax?.buy_tax_pct || 1).toFixed(0)}%`;
        kpiRmv.textContent = fmt(snapshot.my_wallet?.breakeven_mcap || 0);
        kpiCost.textContent = fmt(snapshot.my_wallet?.cost_per_token || 0);

        renderRule(snapshot);
        renderBars(snapshot.minute_series || []);
        renderCurve(snapshot.curves || {});
        renderHolders(snapshot);
        renderSpecial(snapshot);
      }

      async function post(url, body) {
        const r = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body || {}),
        });
        const d = await r.json();
        if (!r.ok) throw new Error(d.error || 'request failed');
        return d;
      }

      $('startBtn').addEventListener('click', async () => {
        try {
          const payload = {
            token_address: tokenInput.value.trim(),
            launch_start_time: Number(launchInput.value || 0),
            wallet_address: walletInput.value.trim(),
            sell_tax_pct: Number(sellTaxInput.value || 1),
          };
          const d = await post('/api/track/start', payload);
          renderSnapshot(d.snapshot);
        } catch (e) {
          alert(e.message || String(e));
        }
      });

      $('stopBtn').addEventListener('click', async () => {
        await post('/api/track/stop', {});
      });

      document.querySelectorAll('[data-mode]').forEach((b) => {
        b.addEventListener('click', async () => {
          const mode = b.getAttribute('data-mode');
          await post('/api/settings/mode', { metric_mode: mode });
        });
      });

      [launchInput, walletInput, sellTaxInput].forEach((el) => {
        el.addEventListener('change', async () => {
          try {
            await post('/api/settings/runtime', {
              launch_start_time: Number(launchInput.value || 0),
              wallet_address: walletInput.value.trim(),
              sell_tax_pct: Number(sellTaxInput.value || 1),
            });
          } catch {}
        });
      });

      const es = new EventSource('/api/events');
      es.addEventListener('update', (ev) => {
        const p = JSON.parse(ev.data);
        renderSnapshot(p.snapshot);
      });
      es.addEventListener('signal', (ev) => {
        const p = JSON.parse(ev.data);
        flashUntil = Date.now() + 10000;
        renderSnapshot(p.snapshot);
      });
      es.onerror = () => {
        statusPill.textContent = 'Status: disconnected | Block: -';
      };

      fetch('/api/status').then((r) => r.json()).then((d) => renderSnapshot(d.snapshot)).catch(() => {});
    </script>
  </body>
</html>
