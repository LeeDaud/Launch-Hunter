<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sniping Decision Panel</title>
    <style>
      :root {
        --bg: #060c14;
        --card: #0f1b2b;
        --card-soft: #132338;
        --text: #e6f1ff;
        --muted: #8aa2bf;
        --line: rgba(120, 155, 190, 0.18);
        --accent: #59b8ff;
        --wait: #6e7c8f;
        --first: #f4b942;
        --second: #49d07d;
        --danger: #ff5d6f;
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        color: var(--text);
        font-family: Segoe UI, Arial, sans-serif;
        background: radial-gradient(1300px 600px at 15% -20%, #183353 0%, #0b1523 45%, var(--bg) 100%);
      }
      .wrap { max-width: 1320px; margin: 0 auto; padding: 18px; }
      .card {
        background: linear-gradient(180deg, rgba(20,39,61,.92), rgba(14,29,47,.92));
        border-radius: 14px;
        padding: 14px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, .25);
      }
      .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
      .input {
        flex: 1;
        min-width: 320px;
        background: #0a1522;
        border: none;
        color: var(--text);
        padding: 12px 14px;
        border-radius: 10px;
        outline: 1px solid rgba(116, 157, 196, .2);
      }
      .btn {
        border: none;
        background: #1b3857;
        color: var(--text);
        padding: 10px 13px;
        border-radius: 9px;
        cursor: pointer;
      }
      .btn:hover { filter: brightness(1.06); }
      .status {
        display: grid;
        grid-template-columns: 220px 1fr;
        gap: 8px;
        margin-top: 10px;
      }
      .pill {
        padding: 8px 10px;
        border-radius: 10px;
        background: rgba(89,184,255,.12);
        color: #b5dcff;
      }
      .mono { font-family: ui-monospace, Menlo, Consolas, monospace; }

      .hero {
        margin-top: 12px;
        display: grid;
        grid-template-columns: 1.2fr .8fr;
        gap: 12px;
      }
      .metric-grid {
        margin-top: 10px;
        display: grid;
        grid-template-columns: repeat(4, minmax(140px, 1fr));
        gap: 8px;
      }
      .metric {
        background: rgba(12, 24, 40, .8);
        border-radius: 10px;
        padding: 8px;
      }
      .metric .k { font-size: 12px; color: var(--muted); }
      .metric .v { font-size: 20px; font-weight: 650; margin-top: 2px; }

      .rule-box {
        background: linear-gradient(180deg, rgba(12, 24, 40, .9), rgba(8, 16, 28, .9));
        border-radius: 12px;
        padding: 12px;
        min-height: 180px;
      }
      .rule-state {
        margin-top: 6px;
        font-size: 26px;
        font-weight: 700;
        letter-spacing: .3px;
      }
      .state-wait { color: var(--wait); }
      .state-first { color: var(--first); }
      .state-second { color: var(--second); }
      .state-trigger { color: var(--danger); }
      .pulse {
        animation: pulse 1s infinite;
      }
      @keyframes pulse {
        0% { opacity: .55; transform: scale(1); }
        50% { opacity: 1; transform: scale(1.02); }
        100% { opacity: .55; transform: scale(1); }
      }

      .bars {
        margin-top: 8px;
        background: rgba(12,24,40,.72);
        border-radius: 10px;
        padding: 8px;
      }
      .bars-grid {
        height: 120px;
        display: grid;
        grid-template-columns: repeat(10, 1fr);
        gap: 6px;
        align-items: end;
      }
      .bar {
        background: linear-gradient(180deg, #6ac8ff, #3176b5);
        border-radius: 6px 6px 2px 2px;
        min-height: 4px;
      }
      .bar-labels {
        margin-top: 6px;
        display: grid;
        grid-template-columns: repeat(10, 1fr);
        gap: 6px;
        font-size: 10px;
        color: var(--muted);
        text-align: center;
      }

      .table-card { margin-top: 12px; }
      table { width: 100%; border-collapse: collapse; font-size: 13px; }
      th, td { padding: 9px 8px; text-align: left; }
      th { color: #a7c8e6; font-weight: 600; }
      tbody tr { border-top: 1px solid rgba(120, 155, 190, .12); }
      tbody tr:hover { background: rgba(53, 93, 132, .15); }
      .table-wrap { max-height: 58vh; overflow: auto; }
      .copy {
        font-size: 11px;
        border: none;
        border-radius: 6px;
        background: rgba(89,184,255,.2);
        color: #c6e7ff;
        padding: 3px 6px;
        cursor: pointer;
      }
      .delta-up { color: #49d07d; }
      .delta-down { color: #ff8c98; }

      @media (max-width: 980px) {
        .hero { grid-template-columns: 1fr; }
        .status { grid-template-columns: 1fr; }
        .metric-grid { grid-template-columns: repeat(2, minmax(120px, 1fr)); }
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="card">
        <div class="row">
          <input id="tokenInput" class="input mono" placeholder="Paste full token CA (0x...)" />
          <button id="startBtn" class="btn">Start</button>
          <button id="stopBtn" class="btn">Stop</button>
          <button data-mode="token_received" class="btn mode-btn" id="modeToken">Mode: Token</button>
          <button data-mode="virtual_spent" class="btn mode-btn" id="modeVirtual">Mode: VIRTUAL</button>
        </div>

        <div class="status">
          <div class="pill mono" id="trackedToken">Tracked: -</div>
          <div class="pill mono" id="statusLine">Status: stopped | Block: -</div>
        </div>
      </div>

      <div class="hero">
        <div class="card">
          <div class="mono" style="color:#bfe2ff; font-size:13px;">1m taxed volume (last 10 minutes)</div>
          <div class="bars">
            <div id="barGrid" class="bars-grid"></div>
            <div id="barLabels" class="bar-labels"></div>
          </div>

          <div class="metric-grid">
            <div class="metric"><div class="k">Near 1m</div><div class="v" id="near1">0</div></div>
            <div class="metric"><div class="k">Near 2m</div><div class="v" id="near2">0</div></div>
            <div class="metric"><div class="k">Near 5m</div><div class="v" id="near5">0</div></div>
            <div class="metric"><div class="k">Cooldown</div><div class="v" id="cooldown">Ready</div></div>
          </div>
        </div>

        <div class="rule-box" id="ruleBox">
          <div class="mono" style="color:#bfe2ff; font-size:13px;">Entry Signal Panel</div>
          <div id="ruleState" class="rule-state state-wait">WAITING</div>
          <div id="ruleDesc" style="margin-top:8px; color:#9bb7cf; font-size:13px;">Threshold sequence not met yet.</div>
          <div id="rulePair" class="mono" style="margin-top:8px; color:#a9c6dd; font-size:12px;">-</div>
        </div>
      </div>

      <div class="card table-card">
        <div class="mono" style="color:#bfe2ff; font-size:13px;">Holder Ranking</div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Address</th>
                <th>Balance</th>
                <th>Cum In</th>
                <th>Cum Out</th>
                <th>Share %</th>
                <th>Delta 5m</th>
                <th>Last Active</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <script>
      const $ = (id) => document.getElementById(id);
      const tokenInput = $('tokenInput');
      const trackedToken = $('trackedToken');
      const statusLine = $('statusLine');
      const tbody = $('tbody');
      const barGrid = $('barGrid');
      const barLabels = $('barLabels');
      const near1 = $('near1');
      const near2 = $('near2');
      const near5 = $('near5');
      const cooldown = $('cooldown');
      const ruleBox = $('ruleBox');
      const ruleState = $('ruleState');
      const ruleDesc = $('ruleDesc');
      const rulePair = $('rulePair');

      const FIRST_THRESHOLD = 3000;
      const SECOND_THRESHOLD = 6000;
      let latestSnapshot = null;
      let flashUntil = 0;

      function shortCA(v) {
        if (!v) return '-';
        return `${v.slice(0, 6)}...${v.slice(-4)}`;
      }

      function parseNum(v, decimals = 18) {
        if (v == null) return 0;
        if (typeof v === 'number') return Number.isFinite(v) ? v : 0;
        const s = String(v).trim();
        if (!s) return 0;
        if (/^-?\d+$/.test(s) && s.length > 14) {
          const neg = s.startsWith('-');
          const abs = neg ? s.slice(1) : s;
          const padded = abs.length <= decimals ? `${'0'.repeat(decimals - abs.length + 1)}${abs}` : abs;
          const i = padded.slice(0, -decimals) || '0';
          const f = (padded.slice(-decimals) || '').slice(0, 8);
          const n = Number(`${neg ? '-' : ''}${i}${f ? `.${f}` : ''}`);
          return Number.isFinite(n) ? n : 0;
        }
        const n = Number(s);
        return Number.isFinite(n) ? n : 0;
      }

      function formatCompact(n) {
        const v = Math.abs(Number(n || 0));
        const sign = Number(n || 0) < 0 ? '-' : '';
        const fmt = (x) => {
          if (x >= 100) return x.toFixed(1);
          if (x >= 10) return x.toFixed(2);
          return x.toFixed(3);
        };
        if (v >= 1e9) return `${sign}${fmt(v / 1e9)}B`;
        if (v >= 1e6) return `${sign}${fmt(v / 1e6)}M`;
        if (v >= 1e3) return `${sign}${fmt(v / 1e3)}K`;
        if (v >= 1) return `${sign}${v.toFixed(2)}`;
        return `${sign}${v.toFixed(4)}`;
      }

      function formatPercent(v) {
        return `${(Number(v || 0)).toFixed(2)}%`;
      }

      function evaluateRuleState(snapshot) {
        const sig = snapshot.signal_state || {};
        const pair = sig.pair || {};
        const v0 = Number(pair.v0 || 0);
        const v1 = Number(pair.v1 || 0);

        if (sig.passed_now) {
          return {
            key: 'trigger',
            title: 'ENTRY TRIGGERED',
            desc: 'Signal fired. Watch cooldown and execution timing.',
          };
        }
        if (v0 > FIRST_THRESHOLD && v1 > SECOND_THRESHOLD) {
          return {
            key: 'second',
            title: 'SECOND THRESHOLD PASSED',
            desc: 'Second minute confirms breakout sequence.',
          };
        }
        if (v0 > FIRST_THRESHOLD) {
          return {
            key: 'first',
            title: 'FIRST THRESHOLD PASSED',
            desc: 'First minute threshold passed. Waiting confirmation.',
          };
        }
        return {
          key: 'wait',
          title: 'WAITING',
          desc: 'Waiting for threshold breakout sequence.',
        };
      }

      function renderBars(series) {
        const data = (series || []).slice(-10);
        const vals = data.map((x) => Number(x.value || 0));
        const max = Math.max(1, ...vals);
        barGrid.innerHTML = vals
          .map((v) => {
            const h = Math.max(4, Math.round((v / max) * 110));
            return `<div class="bar" style="height:${h}px" title="${formatCompact(v)}"></div>`;
          })
          .join('');

        barLabels.innerHTML = data
          .map((x) => {
            const d = new Date(Number(x.minute_ts || 0) * 1000);
            const mm = String(d.getMinutes()).padStart(2, '0');
            return `<span>:${mm}</span>`;
          })
          .join('');
      }

      function renderTable(snapshot) {
        const lb = snapshot.leaderboard || {};
        const whales = lb.whales || [];
        const heatMap = new Map((lb.heat || []).map((x) => [String(x.address || '').toLowerCase(), Number(x.netflow || 0)]));
        const tokenDecimals = Number(snapshot.decimals?.token || 18);

        const rows = whales.map((r) => {
          const addr = String(r.address || '').toLowerCase();
          const balance = r.holder_balance != null ? parseNum(r.holder_balance, tokenDecimals) : parseNum(r.cumulative_received_token || 0);
          const cumIn = parseNum(r.cumulative_received_token_raw ?? r.cumulative_received_token, tokenDecimals);
          const cumOut = parseNum(r.cumulative_spent_virtual_raw ?? r.cumulative_spent_virtual, tokenDecimals);
          const d5 = Number(heatMap.get(addr) || 0);
          return {
            address: addr,
            balance,
            cumIn,
            cumOut,
            d5,
            lastActive: Number(r.last_active_time || 0),
          };
        });

        const totalBalance = rows.reduce((a, b) => a + Math.max(0, b.balance), 0) || 1;

        tbody.innerHTML = rows
          .sort((a, b) => b.balance - a.balance)
          .slice(0, 100)
          .map((r) => {
            const share = (Math.max(0, r.balance) / totalBalance) * 100;
            const d5Cls = r.d5 >= 0 ? 'delta-up' : 'delta-down';
            return `
              <tr>
                <td class="mono" title="${r.address}">${shortCA(r.address)} <button class="copy" data-addr="${r.address}">copy</button></td>
                <td>${formatCompact(r.balance)}</td>
                <td>${formatCompact(r.cumIn)}</td>
                <td>${formatCompact(r.cumOut)}</td>
                <td>${formatPercent(share)}</td>
                <td class="${d5Cls}">${formatCompact(r.d5)}</td>
                <td>${r.lastActive ? new Date(r.lastActive * 1000).toLocaleTimeString() : '-'}</td>
              </tr>
            `;
          })
          .join('');
      }

      function renderSnapshot(snapshot) {
        if (!snapshot) return;
        latestSnapshot = snapshot;

        trackedToken.textContent = `Tracked: ${shortCA(snapshot.token)}`;
        statusLine.textContent = `Status: ${snapshot.running ? 'running' : 'stopped'} | Block: ${snapshot.last_processed_block || '-'}`;

        const w = snapshot.windows || {};
        near1.textContent = formatCompact(Number(w.near_1m || 0));
        const seq0 = Number(w.near_2m_sequence?.[0]?.value || 0);
        const seq1 = Number(w.near_2m_sequence?.[1]?.value || 0);
        near2.textContent = `${formatCompact(seq0)} -> ${formatCompact(seq1)}`;
        near5.textContent = formatCompact(Number(w.near_5m || 0));

        const sig = snapshot.signal_state || {};
        cooldown.textContent = sig.cooling_down
          ? `Until ${new Date(Number(sig.cooldown_until || 0) * 1000).toLocaleTimeString()}`
          : 'Ready';

        renderBars(snapshot.minute_series || []);

        const rule = evaluateRuleState(snapshot);
        ruleState.className = 'rule-state';
        if (rule.key === 'wait') ruleState.classList.add('state-wait');
        if (rule.key === 'first') ruleState.classList.add('state-first');
        if (rule.key === 'second') ruleState.classList.add('state-second');
        if (rule.key === 'trigger') ruleState.classList.add('state-trigger');

        if (Date.now() < flashUntil) ruleState.classList.add('pulse');

        ruleState.textContent = rule.title;
        ruleDesc.textContent = rule.desc;
        const p = sig.pair || {};
        rulePair.textContent = `Pair value: ${formatCompact(Number(p.v0 || 0))} -> ${formatCompact(Number(p.v1 || 0))}`;

        renderTable(snapshot);
      }

      async function post(url, body) {
        const resp = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body || {}),
        });
        const data = await resp.json();
        if (!resp.ok) throw new Error(data.error || 'request failed');
        return data;
      }

      $('startBtn').addEventListener('click', async () => {
        try {
          const token = tokenInput.value.trim();
          const data = await post('/api/track/start', { token_address: token });
          renderSnapshot(data.snapshot);
        } catch (err) {
          alert(err.message || String(err));
        }
      });

      $('stopBtn').addEventListener('click', async () => {
        try {
          await post('/api/track/stop');
          statusLine.textContent = 'Status: stopped | Block: -';
        } catch (err) {
          alert(err.message || String(err));
        }
      });

      document.querySelectorAll('.mode-btn').forEach((btn) => {
        btn.addEventListener('click', async () => {
          const mode = btn.getAttribute('data-mode');
          try {
            await post('/api/settings/mode', { metric_mode: mode });
            document.querySelectorAll('.mode-btn').forEach((x) => (x.style.outline = 'none'));
            btn.style.outline = '2px solid rgba(89,184,255,.6)';
          } catch (err) {
            alert(err.message || String(err));
          }
        });
      });

      tbody.addEventListener('click', async (ev) => {
        const btn = ev.target.closest('[data-addr]');
        if (!btn) return;
        const addr = btn.getAttribute('data-addr');
        if (!addr) return;
        try {
          await navigator.clipboard.writeText(addr);
        } catch {}
      });

      const es = new EventSource('/api/events');
      es.addEventListener('update', (ev) => {
        const payload = JSON.parse(ev.data);
        renderSnapshot(payload.snapshot);
      });
      es.addEventListener('signal', (ev) => {
        const payload = JSON.parse(ev.data);
        if (payload?.snapshot?.signal_state?.passed_now) {
          flashUntil = Date.now() + 12000;
          renderSnapshot(payload.snapshot);
        }
      });
      es.onerror = () => {
        statusLine.textContent = 'Status: disconnected | Block: -';
      };

      fetch('/api/status')
        .then((r) => r.json())
        .then((d) => renderSnapshot(d.snapshot))
        .catch(() => {});
    </script>
  </body>
</html>
