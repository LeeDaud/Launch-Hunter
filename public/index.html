<!doctype html>
<html lang="zh-CN">
    <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#0b1220" />
    <link rel="icon" href="/favicon.ico" sizes="any" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
    <link rel="manifest" href="/manifest.webmanifest" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <title>Virtuals Sniping Decision Console</title>
    <style>
      :root {
        --bg: #070f1a;
        --card: #111f33;
        --card2: #13263d;
        --text: #e6f0ff;
        --muted: #8ea5bf;
        --accent: #65c2ff;
        --ok: #4ed78d;
        --warn: #f0c156;
        --wait: #7d8b9a;
        --danger: #ff5e78;
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        color: var(--text);
        font-family: Segoe UI, Arial, sans-serif;
        background: radial-gradient(1200px 500px at 15% -20%, #1a3d60 0%, #0d1a2a 45%, var(--bg) 100%);
      }
      .wrap { max-width: 1400px; margin: 0 auto; padding: 16px; }
      .card {
        background: linear-gradient(180deg, rgba(20,40,62,.92), rgba(15,30,48,.92));
        border-radius: 12px;
        padding: 12px;
        box-shadow: 0 8px 24px rgba(0,0,0,.22);
      }
      .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
      .input {
        background: #0b1523;
        border: none;
        border-radius: 8px;
        color: var(--text);
        padding: 10px 12px;
        outline: 1px solid rgba(123, 164, 205, .2);
      }
      .mono { font-family: ui-monospace, Menlo, Consolas, monospace; }
      .grow { flex: 1; min-width: 280px; }
      .btn {
        border: none;
        border-radius: 8px;
        padding: 10px 12px;
        background: #1f4163;
        color: var(--text);
        cursor: pointer;
      }
      .btn.active { outline: 2px solid rgba(101,194,255,.8); }
      .btn.btn-light {
        background: rgba(96, 132, 170, .26);
        color: #d8e9f8;
        padding: 10px 10px;
      }
      .btn.btn-light:hover { background: rgba(96, 132, 170, .4); }
      .launch-control {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        min-height: 40px;
      }
      .launch-label {
        color: #9bb7d0;
        font-size: 12px;
        white-space: nowrap;
      }
      .launch-display {
        min-width: 182px;
        text-align: left;
        background: rgba(10, 22, 36, .9);
        outline: 1px solid rgba(123, 164, 205, .2);
      }
      .launch-fallback {
        position: absolute;
        left: -9999px;
        width: 1px;
        height: 1px;
        opacity: 0;
      }
      .launch-modal {
        position: fixed;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 40;
      }
      .launch-modal.hidden { display: none; }
      .launch-backdrop {
        position: absolute;
        inset: 0;
        background: rgba(2, 7, 13, .58);
        backdrop-filter: blur(3px);
      }
      .launch-sheet {
        position: relative;
        width: min(760px, calc(100vw - 24px));
        border-radius: 18px;
        padding: 14px;
        background: linear-gradient(180deg, rgba(21, 37, 58, .82), rgba(14, 26, 44, .86));
        border: 1px solid rgba(158, 197, 233, .2);
        box-shadow: 0 30px 80px rgba(0, 0, 0, .45);
      }
      .launch-sheet-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .launch-sheet-title { font-size: 14px; color: #d8ecff; }
      .launch-sheet-close {
        border: none;
        border-radius: 10px;
        width: 32px;
        height: 32px;
        color: #d4e6f9;
        background: rgba(117, 152, 186, .16);
        cursor: pointer;
      }
      .launch-sheet-value {
        margin-top: 8px;
        color: #aad0ee;
        font-size: 13px;
      }
      .wheel-stage {
        --wheel-item-h: 40px;
        position: relative;
        margin-top: 10px;
        height: calc(var(--wheel-item-h) * 3);
        display: grid;
        grid-template-columns: 1.4fr 1fr 1fr;
        gap: 8px;
      }
      .wheel-focus {
        position: absolute;
        left: 0;
        right: 0;
        top: var(--wheel-item-h);
        height: var(--wheel-item-h);
        border-radius: 10px;
        border: 1px solid rgba(103, 169, 224, .4);
        background: linear-gradient(180deg, rgba(77, 136, 186, .16), rgba(77, 136, 186, .1));
        pointer-events: none;
      }
      .wheel-col {
        position: relative;
        border-radius: 12px;
        overflow: hidden;
        background: rgba(10, 20, 33, .65);
      }
      .wheel-col-title {
        position: absolute;
        top: 4px;
        left: 8px;
        z-index: 2;
        font-size: 11px;
        color: #8eaaca;
      }
      .wheel-list {
        height: calc(var(--wheel-item-h) * 3);
        overflow-y: auto;
        scroll-snap-type: y proximity;
        scrollbar-width: none;
        overscroll-behavior: contain;
        -webkit-overflow-scrolling: touch;
      }
      .wheel-list::-webkit-scrollbar { display: none; }
      .wheel-track { padding: var(--wheel-item-h) 0; }
      .wheel-item {
        height: var(--wheel-item-h);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        color: #9db7d0;
        scroll-snap-align: center;
        scroll-snap-stop: normal;
        user-select: none;
      }
      .wheel-item.active {
        color: #eaf5ff;
        font-weight: 700;
      }
      .launch-sheet-actions {
        margin-top: 12px;
        display: flex;
        justify-content: flex-end;
        gap: 8px;
      }
      .btn.btn-subtle {
        background: rgba(96, 132, 170, .2);
        color: #c6ddf2;
      }
      .status {
        margin-top: 8px;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
      }
      .pill {
        background: rgba(101,194,255,.12);
        color: #c8e8ff;
        border-radius: 8px;
        padding: 8px 10px;
      }
      .hint {
        margin-top: 8px;
        padding: 8px 10px;
        border-radius: 8px;
        font-size: 12px;
        color: #c7d9eb;
        background: rgba(120, 151, 182, .12);
      }
      .hint.ok { color: #bdeecf; background: rgba(78, 215, 141, .14); }
      .hint.warn { color: #ffd89d; background: rgba(240, 193, 86, .14); }
      .hint.err { color: #ffb5c2; background: rgba(255, 94, 120, .14); }
      .wallet-cfg {
        margin-top: 10px;
        display: grid;
        grid-template-columns: 1.1fr auto;
        gap: 8px;
      }
      .wallet-textarea {
        min-height: 86px;
        resize: vertical;
        width: 100%;
      }
      .wallet-actions {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .wallet-tags {
        margin-top: 8px;
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
      }
      .wallet-tag {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 8px;
        border-radius: 999px;
        background: rgba(101,194,255,.14);
        color: #d5ecff;
        font-size: 12px;
      }
      .wallet-tag button {
        border: none;
        background: transparent;
        color: #b6d6ef;
        cursor: pointer;
        font-size: 12px;
      }
      .wallet-label-input {
        width: 120px;
        border: none;
        border-radius: 6px;
        padding: 2px 6px;
        background: rgba(15, 29, 45, .9);
        color: #d8ebfb;
        outline: 1px solid rgba(123, 164, 205, .22);
        font-size: 12px;
      }
      .wallet-name {
        color: #d8ecff;
        margin-right: 6px;
      }
      .mywallet-card { margin-top: 10px; }
      .copy-btn {
        border: none;
        border-radius: 6px;
        padding: 2px 6px;
        background: rgba(100,136,169,.2);
        color: #c8e0f2;
        cursor: pointer;
      }
      .status-chip {
        display: inline-flex;
        align-items: center;
        margin-left: 8px;
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 11px;
        background: rgba(120,151,182,.16);
        color: #bcd5ea;
      }
      .status-chip.queued { background: rgba(240,193,86,.16); color: #ffd99f; }
      .status-chip.running { background: rgba(101,194,255,.16); color: #b8e4ff; }
      .status-chip.done { background: rgba(78,215,141,.16); color: #bcf1d2; }
      .status-chip.error { background: rgba(255,94,120,.16); color: #ffc3cf; }

      .hero {
        margin-top: 10px;
        display: grid;
        grid-template-columns: 1fr 1.2fr .8fr;
        gap: 10px;
      }

      .kpis {
        display: grid;
        grid-template-columns: repeat(2, minmax(120px, 1fr));
        gap: 8px;
      }
      .kpi { background: rgba(12,24,38,.8); border-radius: 8px; padding: 8px; }
      .kpi .k { font-size: 12px; color: var(--muted); }
      .kpi .v { margin-top: 3px; font-size: 18px; font-weight: 700; }

      .rule-title { font-size: 12px; color: #bbddff; }
      .rule-state { margin-top: 6px; font-size: 24px; font-weight: 800; letter-spacing: .4px; }
      .s-wait { color: var(--wait); }
      .s-first { color: var(--warn); }
      .s-second { color: var(--ok); }
      .s-trigger { color: var(--danger); }
      .blink { animation: blink 1s infinite; }
      @keyframes blink { 0% { opacity:.4; } 50% { opacity:1; } 100% { opacity:.4; } }

      .bars { margin-top: 8px; height: 72px; display: grid; grid-template-columns: repeat(10,1fr); gap: 6px; align-items: end; }
      .bar { background: linear-gradient(180deg, #86d4ff, #3f7fb8); border-radius: 4px 4px 2px 2px; min-height: 4px; }

      .curve-wrap { height: 240px; margin-top: 8px; background: rgba(12,24,38,.7); border-radius: 10px; padding: 8px; }
      .curve-legend { display: flex; gap: 16px; font-size: 12px; color: var(--muted); }
      .dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 5px; }

      .panel-grid { margin-top: 10px; display: grid; grid-template-columns: 1.2fr .8fr; gap: 10px; }
      .table-wrap { max-height: 52vh; overflow: auto; }
      table { width: 100%; border-collapse: collapse; font-size: 12px; }
      th, td { padding: 8px 6px; text-align: left; }
      th { color: #abd3ef; }
      tbody tr { border-top: 1px solid rgba(130,160,190,.14); }
      .good { color: var(--ok); }
      .bad { color: #ff8da0; }

      @media (max-width: 1100px) {
        .hero { grid-template-columns: 1fr; }
        .panel-grid { grid-template-columns: 1fr; }
        .status { grid-template-columns: 1fr; }
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="card">
        <div class="row">
          <input id="tokenInput" class="input grow mono" placeholder="Token CA (0x...)" />
          <div class="launch-control">
            <span class="launch-label">Launch Start Time</span>
            <button id="launchDisplayBtn" class="btn launch-display mono" type="button" aria-haspopup="dialog" aria-controls="launchModal">-</button>
            <button id="setNowBtn" class="btn btn-light" type="button">Set Now</button>
            <input type="datetime-local" id="launchStart" class="input mono launch-fallback" aria-label="Launch Start Time fallback" />
          </div>
          <input id="walletInput" class="input mono" style="width:220px" placeholder="My Wallet (0x...)" />
          <input id="sellTaxInput" class="input mono" style="width:110px" placeholder="SellTax %" value="1" />
          <button id="startBtn" class="btn">开始追踪</button>
          <button id="stopBtn" class="btn">停止</button>
          <button id="modeToken" class="btn active" data-mode="token_received">口径 Token</button>
          <button id="modeVirtual" class="btn" data-mode="virtual_spent">口径 Virtual</button>
        </div>
        <div class="wallet-cfg">
          <textarea id="myWalletsInput" class="input mono wallet-textarea" placeholder="Add wallet addresses (one per line)"></textarea>
          <div class="wallet-actions">
            <input id="myWalletFromBlockInput" class="input mono" style="width:170px" placeholder="My FromBlock" />
            <button id="myWalletApplyBtn" class="btn btn-light" type="button">Add Wallets</button>
            <button id="myWalletClearBtn" class="btn btn-light" type="button">Clear Wallets</button>
          </div>
        </div>
        <div id="myWalletTags" class="wallet-tags"></div>
        <div class="mywallet-card">
          <div style="font-size:13px;color:#c3e5ff;margin-bottom:6px;">
            My Wallets
            <span id="myWalletStatusChip" class="status-chip">idle</span>
          </div>
          <div class="table-wrap" style="max-height:none;">
            <table>
              <thead>
                <tr>
                  <th>Scope</th>
                  <th>Balance</th>
                  <th>Spent V</th>
                  <th>Recv T</th>
                  <th>Cost</th>
                  <th>Eff Cost</th>
                  <th>BE MCAP</th>
                  <th>Last Active</th>
                </tr>
              </thead>
              <tbody id="myWalletTotalBody"></tbody>
            </table>
          </div>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>Address</th>
                  <th>Balance</th>
                  <th>Spent V</th>
                  <th>Recv T</th>
                  <th>Cost</th>
                  <th>Eff Cost</th>
                  <th>BE MCAP</th>
                  <th>Last Active</th>
                </tr>
              </thead>
              <tbody id="myWalletBody"></tbody>
            </table>
          </div>
        </div>
        <div class="status">
          <div id="tokenPill" class="pill mono">Token: -</div>
          <div id="statusPill" class="pill mono">Status: stopped | Block: -</div>
          <div id="transferPill" class="pill mono">Transfers: -</div>
        </div>
        <div id="actionHint" class="hint">Ready.</div>
      </div>

      <div class="hero">
        <div class="card">
          <div class="rule-title">规则状态</div>
          <div id="ruleState" class="rule-state s-wait">等待中</div>
          <div id="ruleDesc" style="font-size:12px;color:#9fb8ce;margin-top:5px;">等待连续两分钟突破 3000 / 6000</div>
          <div id="taxNow" style="margin-top:8px;font-size:13px;color:#c7e6ff;">当前买入税率: 1%</div>
          <div id="pairNow" class="mono" style="margin-top:4px;font-size:12px;color:#aac7dd;">Pair: -</div>
          <div class="bars" id="bars"></div>
        </div>

        <div class="card">
          <div class="curve-legend">
            <span><i class="dot" style="background:#67c4ff"></i>EMV</span>
            <span><i class="dot" style="background:#f8b24f"></i>RMV</span>
          </div>
          <div class="curve-wrap">
            <svg id="curveSvg" viewBox="0 0 1000 240" width="100%" height="100%"></svg>
          </div>
        </div>

        <div class="card">
          <div class="kpis">
            <div class="kpi"><div class="k">1m Taxed Vol</div><div id="kpi1" class="v">0</div></div>
            <div class="kpi"><div class="k">2m Seq</div><div id="kpi2" class="v">0</div></div>
            <div class="kpi"><div class="k">5m Taxed Vol</div><div id="kpi5" class="v">0</div></div>
            <div class="kpi"><div class="k">Cooldown</div><div id="kpiCd" class="v">Ready</div></div>
            <div class="kpi"><div class="k">My RMV</div><div id="kpiRmv" class="v">0</div></div>
            <div class="kpi"><div class="k">My Cost</div><div id="kpiCost" class="v">0</div></div>
          </div>
        </div>
      </div>

      <div class="panel-grid">
        <div class="card">
          <div style="font-size:13px;color:#c3e5ff;margin-bottom:6px;">Holders</div>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>Address</th>
                  <th>Balance</th>
                  <th>Cum In</th>
                  <th>Cum Out</th>
                  <th>Share%</th>
                  <th>Δ5m</th>
                  <th>Cost</th>
                  <th>BE MCAP</th>
                </tr>
              </thead>
              <tbody id="holderBody"></tbody>
            </table>
          </div>
        </div>

        <div class="card">
          <div style="font-size:13px;color:#c3e5ff;margin-bottom:6px;">Special Protocol Flows</div>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>Label</th>
                  <th>Category</th>
                  <th>5m V</th>
                  <th>1h V</th>
                  <th>Cum V</th>
                  <th>5m T</th>
                  <th>Cum T</th>
                </tr>
              </thead>
              <tbody id="specialBody"></tbody>
            </table>
          </div>
        </div>
      </div>

    </div>

    <div id="launchModal" class="launch-modal hidden" role="dialog" aria-modal="true" aria-labelledby="launchSheetTitle">
      <div id="launchBackdrop" class="launch-backdrop"></div>
      <div class="launch-sheet">
        <div class="launch-sheet-header">
          <div id="launchSheetTitle" class="launch-sheet-title">Select Launch Start Time</div>
          <button id="launchCloseBtn" class="launch-sheet-close" type="button" aria-label="Close">X</button>
        </div>
        <div id="launchSheetValue" class="launch-sheet-value mono">-</div>
        <div class="wheel-stage">
          <div class="wheel-focus"></div>
          <div class="wheel-col">
            <div class="wheel-col-title">Date</div>
            <div id="wheelDate" class="wheel-list" role="listbox" aria-label="Date"></div>
          </div>
          <div class="wheel-col">
            <div class="wheel-col-title">Hour</div>
            <div id="wheelHour" class="wheel-list" role="listbox" aria-label="Hour"></div>
          </div>
          <div class="wheel-col">
            <div class="wheel-col-title">Minute</div>
            <div id="wheelMinute" class="wheel-list" role="listbox" aria-label="Minute"></div>
          </div>
        </div>
        <div class="launch-sheet-actions">
          <button id="launchCancelBtn" class="btn btn-subtle" type="button">Cancel</button>
          <button id="launchConfirmBtn" class="btn" type="button">Confirm</button>
        </div>
      </div>
    </div>

    <script>
      const $ = (id) => document.getElementById(id);
      const tokenInput = $('tokenInput');
      const launchInput = $('launchStart');
      const walletInput = $('walletInput');
      const sellTaxInput = $('sellTaxInput');
      const launchDisplayBtn = $('launchDisplayBtn');
      const setNowBtn = $('setNowBtn');
      const startBtn = $('startBtn');
      const stopBtn = $('stopBtn');
      const actionHint = $('actionHint');
      const myWalletsInput = $('myWalletsInput');
      const myWalletFromBlockInput = $('myWalletFromBlockInput');
      const myWalletApplyBtn = $('myWalletApplyBtn');
      const myWalletClearBtn = $('myWalletClearBtn');
      const myWalletTags = $('myWalletTags');
      const myWalletTotalBody = $('myWalletTotalBody');
      const myWalletBody = $('myWalletBody');
      const myWalletStatusChip = $('myWalletStatusChip');
      const launchModal = $('launchModal');
      const launchBackdrop = $('launchBackdrop');
      const launchCloseBtn = $('launchCloseBtn');
      const launchCancelBtn = $('launchCancelBtn');
      const launchConfirmBtn = $('launchConfirmBtn');
      const launchSheetValue = $('launchSheetValue');
      const wheelDate = $('wheelDate');
      const wheelHour = $('wheelHour');
      const wheelMinute = $('wheelMinute');
      const tokenPill = $('tokenPill');
      const statusPill = $('statusPill');
      const transferPill = $('transferPill');
      const ruleState = $('ruleState');
      const ruleDesc = $('ruleDesc');
      const taxNow = $('taxNow');
      const pairNow = $('pairNow');
      const bars = $('bars');
      const curveSvg = $('curveSvg');
      const holderBody = $('holderBody');
      const specialBody = $('specialBody');
      const kpi1 = $('kpi1');
      const kpi2 = $('kpi2');
      const kpi5 = $('kpi5');
      const kpiCd = $('kpiCd');
      const kpiRmv = $('kpiRmv');
      const kpiCost = $('kpiCost');

      let latest = null;
      let flashUntil = 0;
      const LAUNCH_START_KEY = 'launchStartTime';
      const clamp = (v, lo, hi) => Math.min(hi, Math.max(lo, v));
      const WHEEL_ITEM_HEIGHT = 40;
      const WHEEL_SNAP_DELAY = 240;
      const pickerState = {
        dateOptions: [],
        hourOptions: Array.from({ length: 24 }, (_, i) => i),
        minuteOptions: Array.from({ length: 12 }, (_, i) => i * 5),
        selectedDateIndex: 0,
        selectedHourIndex: 0,
        selectedMinuteIndex: 0,
      };
      const wheelTimers = {};
      const wheelLastTop = {};
      const LS_TOKEN_KEY = 'lastTrackedToken';
      const LS_WALLET_KEY = 'lastWalletAddress';
      const LS_MY_WALLETS_KEY = 'myWalletsList';
      const LS_MY_WALLETS_LABELS_KEY = 'myWalletsLabels';
      const LS_MY_FROM_BLOCK_KEY = 'myWalletFromBlock';
      let eventSource = null;
      let sseRetryTimer = null;
      let startBusy = false;
      let stopBusy = false;
      let myWallets = [];
      let walletLabels = {};
      let launchStartSec = 0;

      function toLocalDatetimeValue(date) {
        const y = date.getFullYear();
        const m = String(date.getMonth() + 1).padStart(2, '0');
        const d = String(date.getDate()).padStart(2, '0');
        const hh = String(date.getHours()).padStart(2, '0');
        const mm = String(date.getMinutes()).padStart(2, '0');
        return `${y}-${m}-${d}T${hh}:${mm}`;
      }

      function formatLocalDisplayFromSeconds(sec) {
        if (!Number.isFinite(sec) || sec <= 0) return '-';
        const d = new Date(sec * 1000);
        const y = d.getFullYear();
        const mo = String(d.getMonth() + 1).padStart(2, '0');
        const da = String(d.getDate()).padStart(2, '0');
        const hh = String(d.getHours()).padStart(2, '0');
        const mm = String(d.getMinutes()).padStart(2, '0');
        return `${y}-${mo}-${da} ${hh}:${mm}`;
      }

      function parseLaunchStartSeconds() {
        if (Number.isFinite(launchStartSec) && launchStartSec > 0) return launchStartSec;
        if (!launchInput.value) return 0;
        const ms = new Date(launchInput.value).getTime();
        if (!Number.isFinite(ms)) return 0;
        launchStartSec = Math.floor(ms / 1000);
        return launchStartSec;
      }

      function setLaunchInputBySeconds(sec) {
        if (!Number.isFinite(sec) || sec <= 0) return;
        launchStartSec = Math.floor(sec);
        launchInput.value = toLocalDatetimeValue(new Date(launchStartSec * 1000));
        launchDisplayBtn.textContent = formatLocalDisplayFromSeconds(sec);
      }

      function computeBuyTaxPctFromStart(startSec) {
        if (!Number.isFinite(startSec) || startSec <= 0) return 1;
        const nowSec = Math.floor(Date.now() / 1000);
        const minutes = Math.floor((nowSec - startSec) / 60);
        return clamp(99 - minutes, 1, 99);
      }

      async function applyLaunchStartChange(pushRuntime = true) {
        const startSec = parseLaunchStartSeconds();
        localStorage.setItem(LAUNCH_START_KEY, String(startSec));
        launchDisplayBtn.textContent = formatLocalDisplayFromSeconds(startSec);

        if (latest) {
          latest.tax = latest.tax || {};
          latest.tax.buy_tax_pct = computeBuyTaxPctFromStart(startSec);
          latest.tax.launch_start_time = startSec;
          renderSnapshot(latest);
        }

        if (!pushRuntime) return;
        try {
          const d = await post('/api/settings/runtime', {
            launch_start_time: startSec,
            wallet_address: walletInput.value.trim(),
            sell_tax_pct: Number(sellTaxInput.value || 1),
          });
          if (d?.snapshot) renderSnapshot(d.snapshot);
        } catch {}
      }

      function initLaunchStartInput() {
        const saved = Number(localStorage.getItem(LAUNCH_START_KEY) || 0);
        if (saved > 0) {
          setLaunchInputBySeconds(saved);
        } else {
          const nowSec = Math.floor(Date.now() / 1000);
          setLaunchInputBySeconds(nowSec);
          localStorage.setItem(LAUNCH_START_KEY, String(nowSec));
        }
      }

      function startOfLocalDay(d) {
        return new Date(d.getFullYear(), d.getMonth(), d.getDate(), 0, 0, 0, 0);
      }

      function sameLocalDay(a, b) {
        return a.getFullYear() === b.getFullYear()
          && a.getMonth() === b.getMonth()
          && a.getDate() === b.getDate();
      }

      function buildDateOptions() {
        const now = new Date();
        const today = startOfLocalDay(now);
        const list = [];
        for (let i = 0; i < 7; i += 1) {
          const d = new Date(today);
          d.setDate(today.getDate() - i);
          let label = `${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
          if (i === 0) label = '今天';
          if (i === 1) label = '昨天';
          list.push({ date: d, label });
        }
        return list;
      }

      function renderWheel(wheelEl, options, labelFn) {
        const items = options.map((opt, idx) => `<div class="wheel-item" data-idx="${idx}">${labelFn(opt)}</div>`).join('');
        wheelEl.innerHTML = `<div class="wheel-track">${items}</div>`;
      }

      function markWheelSelected(wheelEl, idx) {
        wheelEl.querySelectorAll('.wheel-item').forEach((el, i) => {
          el.classList.toggle('active', i === idx);
        });
      }

      function scrollWheelToIndex(wheelEl, idx, smooth = false) {
        wheelEl.scrollTo({
          top: idx * WHEEL_ITEM_HEIGHT,
          behavior: smooth ? 'smooth' : 'auto',
        });
        markWheelSelected(wheelEl, idx);
      }

      function getPickerSelectedDate() {
        const dateObj = pickerState.dateOptions[pickerState.selectedDateIndex]?.date || startOfLocalDay(new Date());
        const h = pickerState.hourOptions[pickerState.selectedHourIndex] || 0;
        const m = pickerState.minuteOptions[pickerState.selectedMinuteIndex] || 0;
        return new Date(
          dateObj.getFullYear(),
          dateObj.getMonth(),
          dateObj.getDate(),
          h,
          m,
          0,
          0
        );
      }

      function updatePickerPreview() {
        launchSheetValue.textContent = formatLocalDisplayFromSeconds(Math.floor(getPickerSelectedDate().getTime() / 1000));
      }

      function bindWheel(wheelEl, key, length) {
        wheelEl.addEventListener('click', (ev) => {
          const item = ev.target?.closest?.('.wheel-item');
          if (!item) return;
          const idx = clamp(Number(item.getAttribute('data-idx') || 0), 0, length - 1);
          if (key === 'date') pickerState.selectedDateIndex = idx;
          if (key === 'hour') pickerState.selectedHourIndex = idx;
          if (key === 'minute') pickerState.selectedMinuteIndex = idx;
          scrollWheelToIndex(wheelEl, idx, true);
          updatePickerPreview();
        });

        wheelEl.addEventListener('scroll', () => {
          clearTimeout(wheelTimers[key]);
          const top = wheelEl.scrollTop;
          const idx = clamp(Math.round(top / WHEEL_ITEM_HEIGHT), 0, length - 1);
          const prevTop = Number(wheelLastTop[key] || 0);
          const delta = Math.abs(top - prevTop);
          wheelLastTop[key] = top;
          markWheelSelected(wheelEl, idx);
          wheelTimers[key] = setTimeout(() => {
            if (key === 'date') pickerState.selectedDateIndex = idx;
            if (key === 'hour') pickerState.selectedHourIndex = idx;
            if (key === 'minute') pickerState.selectedMinuteIndex = idx;
            scrollWheelToIndex(wheelEl, idx, delta > 8);
            updatePickerPreview();
          }, WHEEL_SNAP_DELAY);
        }, { passive: true });
      }

      function openLaunchModal() {
        pickerState.dateOptions = buildDateOptions();
        renderWheel(wheelDate, pickerState.dateOptions, (x) => x.label);
        renderWheel(wheelHour, pickerState.hourOptions, (x) => String(x).padStart(2, '0'));
        renderWheel(wheelMinute, pickerState.minuteOptions, (x) => String(x).padStart(2, '0'));

        const baseSec = parseLaunchStartSeconds();
        const base = baseSec > 0 ? new Date(baseSec * 1000) : new Date();
        const foundDateIdx = pickerState.dateOptions.findIndex((x) => sameLocalDay(x.date, base));
        pickerState.selectedDateIndex = foundDateIdx >= 0 ? foundDateIdx : 0;
        pickerState.selectedHourIndex = base.getHours();
        const nearestMinute = clamp(Math.round(base.getMinutes() / 5) * 5, 0, 55);
        pickerState.selectedMinuteIndex = Math.round(nearestMinute / 5);

        scrollWheelToIndex(wheelDate, pickerState.selectedDateIndex, false);
        scrollWheelToIndex(wheelHour, pickerState.selectedHourIndex, false);
        scrollWheelToIndex(wheelMinute, pickerState.selectedMinuteIndex, false);
        updatePickerPreview();

        launchModal.classList.remove('hidden');
      }

      function closeLaunchModal() {
        launchModal.classList.add('hidden');
      }

      function setHint(text, level = '') {
        actionHint.textContent = text;
        actionHint.className = `hint${level ? ` ${level}` : ''}`;
      }

      function setButtonBusy(btn, busy, busyText, idleText) {
        btn.disabled = busy;
        btn.textContent = busy ? busyText : idleText;
        btn.style.opacity = busy ? '0.7' : '1';
        btn.style.cursor = busy ? 'not-allowed' : 'pointer';
      }

      function normalizeWalletList(rawText) {
        const lines = String(rawText || '').split(/\r?\n/).map((x) => x.trim()).filter(Boolean);
        const map = new Map();
        for (const line of lines) {
          if (/^0x[a-fA-F0-9]{40}$/.test(line)) map.set(line.toLowerCase(), line);
        }
        return Array.from(map.keys());
      }

      function syncWalletLabelMap() {
        const next = {};
        for (const addr of myWallets) next[addr] = String(walletLabels?.[addr] || '');
        walletLabels = next;
      }

      function getWalletLabel(addr) {
        const v = String(walletLabels?.[addr] || '').trim();
        return v || '';
      }

      function renderMyWalletTags() {
        myWalletTags.innerHTML = myWallets.map((addr) => `
          <span class="wallet-tag">
            <span class="mono">${shortAddr(addr)}</span>
            <input class="wallet-label-input" data-label-wallet="${addr}" type="text" maxlength="24" placeholder="Name" value="${getWalletLabel(addr).replace(/"/g, '&quot;')}" />
            <button data-del-wallet="${addr}" type="button">x</button>
          </span>
        `).join('');
      }

      async function applyMyWalletsRuntime(push = true) {
        syncWalletLabelMap();
        renderMyWalletTags();
        localStorage.setItem(LS_MY_WALLETS_KEY, JSON.stringify(myWallets));
        localStorage.setItem(LS_MY_WALLETS_LABELS_KEY, JSON.stringify(walletLabels || {}));
        localStorage.setItem(LS_MY_FROM_BLOCK_KEY, String(Number(myWalletFromBlockInput.value || 0)));
        if (!push) return;
        try {
          await post('/api/settings/runtime', {
            launch_start_time: parseLaunchStartSeconds(),
            wallet_address: walletInput.value.trim(),
            sell_tax_pct: Number(sellTaxInput.value || 1),
            myWallets: myWallets,
            my_wallet_from_block: Number(myWalletFromBlockInput.value || 0),
          });
          setHint(`My Wallets updated (${myWallets.length})`, 'ok');
        } catch (e) {
          setHint(`Wallet update failed: ${e.message || String(e)}`, 'err');
        }
      }

      function shortAddr(v) {
        if (!v) return '-';
        return `${v.slice(0, 6)}...${v.slice(-4)}`;
      }

      function fmt(n) {
        const v = Number(n || 0);
        const sign = v < 0 ? '-' : '';
        const x = Math.abs(v);
        const pick = (d) => (x >= 100 ? d.toFixed(1) : x >= 10 ? d.toFixed(2) : d.toFixed(3));
        if (x >= 1e12) return `${sign}${pick(x / 1e12)}T`;
        if (x >= 1e9) return `${sign}${pick(x / 1e9)}B`;
        if (x >= 1e6) return `${sign}${pick(x / 1e6)}M`;
        if (x >= 1e3) return `${sign}${pick(x / 1e3)}K`;
        if (x >= 1) return `${sign}${x.toFixed(2)}`;
        return `${sign}${x.toFixed(4)}`;
      }

      function setModeBtn(mode) {
        $('modeToken').classList.toggle('active', mode === 'token_received');
        $('modeVirtual').classList.toggle('active', mode === 'virtual_spent');
      }

      function renderBars(series) {
        const d = (series || []).slice(-10);
        const max = Math.max(1, ...d.map((x) => Number(x.value || 0)));
        bars.innerHTML = d.map((x) => {
          const h = Math.max(4, Math.round((Number(x.value || 0) / max) * 64));
          return `<div class="bar" style="height:${h}px" title="${fmt(x.value)}"></div>`;
        }).join('');
      }

      function renderCurve(curves) {
        const emv = curves?.emvSeries || [];
        const rmv = curves?.rmvSeries || [];
        const n = Math.max(emv.length, rmv.length);
        if (!n) {
          curveSvg.innerHTML = '';
          return;
        }

        const emvVals = emv.map((x) => Number(x.value || 0));
        const rmvVals = rmv.map((x) => Number(x.value || 0));
        const all = [...emvVals, ...rmvVals].filter((x) => Number.isFinite(x));
        const max = Math.max(1, ...all);
        const min = Math.min(0, ...all);
        const h = 220;

        const px = (i) => (i / Math.max(1, n - 1)) * 980 + 10;
        const py = (v) => {
          const ratio = (v - min) / Math.max(1e-9, max - min);
          return h - ratio * 200 + 10;
        };

        const emvPts = emvVals.map((v, i) => `${px(i)},${py(v)}`).join(' ');
        const rmvPts = rmvVals.map((v, i) => `${px(i)},${py(v)}`).join(' ');

        curveSvg.innerHTML = `
          <polyline points="${emvPts}" fill="none" stroke="#67c4ff" stroke-width="3" />
          <polyline points="${rmvPts}" fill="none" stroke="#f8b24f" stroke-width="2.5" stroke-dasharray="5 3" />
          <text x="12" y="18" fill="#9fc2df" font-size="12">max ${fmt(max)}</text>
          <text x="12" y="232" fill="#9fc2df" font-size="12">min ${fmt(min)}</text>
        `;
      }

      function renderHolders(snapshot) {
        const rows = (snapshot.holder_stats || []).slice().sort((a, b) => Number(b.balance || 0) - Number(a.balance || 0)).slice(0, 120);
        holderBody.innerHTML = rows.map((r) => {
          const delta = Number(r.delta_5m_token || 0);
          const cls = delta >= 0 ? 'good' : 'bad';
          return `
            <tr>
              <td class="mono" title="${r.address}">${shortAddr(r.address)}</td>
              <td>${fmt(r.balance)}</td>
              <td>${fmt(r.cumulative_in)}</td>
              <td>${fmt(r.cumulative_out)}</td>
              <td>${Number(r.share_pct || 0).toFixed(2)}%</td>
              <td class="${cls}">${fmt(delta)}</td>
              <td>${fmt(r.cost_per_token)}</td>
              <td>${fmt(r.breakeven_mcap)}</td>
            </tr>
          `;
        }).join('');
      }

      function renderSpecial(snapshot) {
        const rows = snapshot.special_stats || [];
        specialBody.innerHTML = rows.map((r) => {
          const c = Number(r.net_virtual_5m || 0) >= 0 ? 'good' : 'bad';
          return `
            <tr>
              <td>${r.label}</td>
              <td>${r.category}</td>
              <td class="${c}">${fmt(r.net_virtual_5m)}</td>
              <td>${fmt(r.net_virtual_1h)}</td>
              <td>${fmt(r.net_virtual_cum)}</td>
              <td>${fmt(r.net_token_5m)}</td>
              <td>${fmt(r.net_token_cum)}</td>
            </tr>
          `;
        }).join('');
      }

      function renderRule(snapshot) {
        const sig = snapshot.signal_state || {};
        const pair = sig.pair || {};
        const v0 = Number(pair.v0 || 0);
        const v1 = Number(pair.v1 || 0);

        ruleState.className = 'rule-state';
        let text = '等待';
        let desc = '等待连续两分钟突破 3000 / 6000';

        if (sig.passed_now) {
          text = '入场触发';
          desc = '规则已触发，进入冷却期';
          ruleState.classList.add('s-trigger');
        } else if (v0 > 3000 && v1 > 6000) {
          text = '第二阈值确认';
          desc = '连续两分钟突破成立';
          ruleState.classList.add('s-second');
        } else if (v0 > 3000) {
          text = '第一阈值突破';
          desc = '等待第二分钟确认';
          ruleState.classList.add('s-first');
        } else {
          ruleState.classList.add('s-wait');
        }

        if (Date.now() < flashUntil) ruleState.classList.add('blink');
        ruleState.textContent = text;
        ruleDesc.textContent = desc;
        pairNow.textContent = `Pair: ${fmt(v0)} -> ${fmt(v1)}`;
      }

      function renderSnapshot(snapshot) {
        if (!snapshot) return;
        latest = snapshot;

        tokenPill.textContent = `Token: ${shortAddr(snapshot.token)}`;
        statusPill.textContent = `Status: ${snapshot.running ? 'running' : 'stopped'} | Block: ${snapshot.last_processed_block || '-'}`;
        const ingest = snapshot.ingest || {};
        if (!ingest.counterparty_configured) {
          transferPill.textContent = 'Transfers: set VIRTUAL_CA / VIRTUAL_TOKEN_ADDRESS';
        } else if (ingest.no_transfers_in_window) {
          transferPill.textContent = 'Transfers: no transfers in window';
        } else if (Number(ingest.log_count || 0) > 0) {
          transferPill.textContent = `Transfers: logs ${Number(ingest.log_count || 0)} | tx ${Number(ingest.tx_count || 0)}`;
        } else {
          transferPill.textContent = 'Transfers: waiting...';
        }
        setModeBtn(snapshot.metric_mode);

        const w = snapshot.windows || {};
        kpi1.textContent = fmt(w.near_1m);
        kpi2.textContent = `${fmt(w.near_2m_sequence?.[0]?.value || 0)} -> ${fmt(w.near_2m_sequence?.[1]?.value || 0)}`;
        kpi5.textContent = fmt(w.near_5m);
        kpiCd.textContent = snapshot.signal_state?.cooling_down
          ? new Date(Number(snapshot.signal_state.cooldown_until || 0) * 1000).toLocaleTimeString()
          : 'Ready';

        taxNow.textContent = `当前买入税率: ${Number(snapshot.tax?.buy_tax_pct || 1).toFixed(0)}%`;
        kpiRmv.textContent = fmt(snapshot.my_wallet?.breakeven_mcap || 0);
        kpiCost.textContent = fmt(snapshot.my_wallet?.cost_per_token || 0);

        renderRule(snapshot);
        renderBars(snapshot.minute_series || []);
        renderCurve(snapshot.curves || {});
        renderHolders(snapshot);
        renderSpecial(snapshot);
        renderMyWalletStats(snapshot.my_wallets || {});
      }

      function renderMyWalletStats(data) {
        const st = data?.status || {};
        const state = String(st.state || 'idle');
        const stateText = state === 'running'
          ? 'backfill running'
          : state === 'queued'
            ? 'backfill queued'
            : state === 'done'
              ? 'backfill done'
              : state === 'error'
                ? 'backfill error'
                : 'idle';
        myWalletStatusChip.className = `status-chip ${state}`;
        myWalletStatusChip.textContent = stateText;
        myWalletStatusChip.title = st.last_error
          ? `Error: ${st.last_error}`
          : (st.last_at ? `Last: ${new Date(st.last_at * 1000).toLocaleTimeString()} | Reason: ${st.last_reason || '-'}` : 'No backfill yet');

        const t = data?.total || {};
        myWalletTotalBody.innerHTML = `
          <tr>
            <td>Total (${(data?.addresses || []).length})</td>
            <td>${fmt(t.balance || 0)}</td>
            <td>${fmt(t.spent_virtual_sum || 0)}</td>
            <td>${fmt(t.received_token_sum || 0)}</td>
            <td>${fmt(t.cost_per_token || 0)}</td>
            <td>${fmt(t.effective_cost_per_token || 0)}</td>
            <td>${fmt(t.breakeven_mcap || 0)}</td>
            <td>-</td>
          </tr>
        `;
        const rows = data?.rows || [];
        myWalletBody.innerHTML = rows.map((r) => `
          <tr>
            <td class="mono">
              ${getWalletLabel(r.address) ? `<span class="wallet-name">${getWalletLabel(r.address)}</span>` : ''}
              ${shortAddr(r.address)}
              <button class="copy-btn" data-copy="${r.address}" type="button">Copy</button>
            </td>
            <td>${fmt(r.balance)}</td>
            <td>${fmt(r.spent_virtual_sum)}</td>
            <td>${fmt(r.received_token_sum)}</td>
            <td>${fmt(r.cost_per_token)}</td>
            <td>${fmt(r.effective_cost_per_token)}</td>
            <td>${fmt(r.breakeven_mcap)}</td>
            <td>${r.last_active_time ? new Date(r.last_active_time * 1000).toLocaleTimeString() : '-'}</td>
          </tr>
        `).join('');
      }

      async function post(url, body, timeoutMs = 15000) {
        const controller = new AbortController();
        const timer = setTimeout(() => controller.abort(), timeoutMs);
        try {
          const r = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body || {}),
            signal: controller.signal,
          });
          let d = null;
          try { d = await r.json(); } catch { d = {}; }
          if (!r.ok) throw new Error(d.error || 'request failed');
          return d;
        } finally {
          clearTimeout(timer);
        }
      }

      async function refreshStatusOnce() {
        const d = await fetch('/api/status', { cache: 'no-store' }).then((r) => r.json());
        if (d?.snapshot) renderSnapshot(d.snapshot);
        return d;
      }

      startBtn.addEventListener('click', async () => {
        if (startBusy) return;
        try {
          const token = tokenInput.value.trim();
          if (!/^0x[a-fA-F0-9]{40}$/.test(token)) {
            setHint('Token 地址格式无效，请输入 0x 开头的 42 位地址。', 'err');
            return;
          }
          startBusy = true;
          setButtonBusy(startBtn, true, '启动中...', '开始追踪');
          setHint('正在启动追踪任务并进行回扫...', 'warn');

          const payload = {
            token_address: token,
            launch_start_time: parseLaunchStartSeconds(),
            wallet_address: walletInput.value.trim(),
            sell_tax_pct: Number(sellTaxInput.value || 1),
            myWallets: myWallets,
            my_wallet_from_block: Number(myWalletFromBlockInput.value || 0),
          };
          const d = await post('/api/track/start', payload, 30000);
          renderSnapshot(d.snapshot);
          localStorage.setItem(LS_TOKEN_KEY, token);
          localStorage.setItem(LS_WALLET_KEY, walletInput.value.trim());
          setHint('追踪已启动。', 'ok');
        } catch (e) {
          const msg = String(e?.message || e || '');
          if (msg.toLowerCase().includes('abort')) {
            try {
              const st = await refreshStatusOnce();
              if (st?.status?.running) {
                setHint('启动请求超时，但任务已在后台运行。', 'warn');
              } else {
                setHint('启动超时，任务可能未成功启动。', 'err');
              }
            } catch {
              setHint('启动超时，且状态回查失败。', 'err');
            }
          } else {
            setHint(`启动失败: ${msg}`, 'err');
          }
        } finally {
          startBusy = false;
          setButtonBusy(startBtn, false, '启动中...', '开始追踪');
        }
      });

      stopBtn.addEventListener('click', async () => {
        if (stopBusy) return;
        try {
          stopBusy = true;
          setButtonBusy(stopBtn, true, '停止中...', '停止');
          setHint('正在停止追踪任务...', 'warn');
          await post('/api/track/stop', {}, 15000);
          const st = await fetch('/api/status').then((r) => r.json());
          if (st?.snapshot) renderSnapshot(st.snapshot);
          statusPill.textContent = 'Status: stopped | Block: -';
          transferPill.textContent = 'Transfers: -';
          setHint('追踪已停止。', 'ok');
        } catch (e) {
          const msg = String(e?.message || e || '');
          if (msg.toLowerCase().includes('abort')) {
            try {
              const st = await refreshStatusOnce();
              if (!st?.status?.running) setHint('停止请求超时，但任务已停止。', 'warn');
              else setHint('停止超时，任务可能仍在运行。', 'err');
            } catch {
              setHint('停止超时，且状态回查失败。', 'err');
            }
          } else {
            setHint(`停止失败: ${msg}`, 'err');
          }
        } finally {
          stopBusy = false;
          setButtonBusy(stopBtn, false, '停止中...', '停止');
        }
      });

      document.querySelectorAll('[data-mode]').forEach((b) => {
        b.addEventListener('click', async () => {
          const mode = b.getAttribute('data-mode');
          await post('/api/settings/mode', { metric_mode: mode });
        });
      });

      [walletInput, sellTaxInput].forEach((el) => {
        el.addEventListener('change', async () => {
          try {
            await post('/api/settings/runtime', {
              launch_start_time: parseLaunchStartSeconds(),
              wallet_address: walletInput.value.trim(),
              sell_tax_pct: Number(sellTaxInput.value || 1),
              myWallets: myWallets,
              my_wallet_from_block: Number(myWalletFromBlockInput.value || 0),
            });
            setHint('运行参数已更新。', 'ok');
          } catch {}
        });
      });

      myWalletApplyBtn.addEventListener('click', () => {
        const incoming = normalizeWalletList(myWalletsInput.value);
        if (!incoming.length) {
          setHint('No valid wallet address found. Please input one address per line.', 'err');
          return;
        }
        const before = new Set(myWallets);
        for (const addr of incoming) before.add(addr);
        const next = Array.from(before);
        const added = next.length - myWallets.length;
        myWallets = next;
        myWalletsInput.value = '';
        applyMyWalletsRuntime(true);
        setHint(added > 0 ? `Added ${added} wallet(s). Total ${myWallets.length}.` : 'All addresses already exist.', added > 0 ? 'ok' : 'warn');
      });

      myWalletClearBtn.addEventListener('click', () => {
        myWallets = [];
        walletLabels = {};
        myWalletsInput.value = '';
        renderMyWalletTags();
        applyMyWalletsRuntime(true);
      });

      myWalletTags.addEventListener('click', (ev) => {
        const btn = ev.target?.closest?.('[data-del-wallet]');
        if (!btn) return;
        const addr = btn.getAttribute('data-del-wallet');
        myWallets = myWallets.filter((x) => x !== addr);
        delete walletLabels[addr];
        renderMyWalletTags();
        applyMyWalletsRuntime(true);
      });

      myWalletTags.addEventListener('input', (ev) => {
        const input = ev.target?.closest?.('[data-label-wallet]');
        if (!input) return;
        const addr = input.getAttribute('data-label-wallet');
        walletLabels[addr] = String(input.value || '').trim();
        localStorage.setItem(LS_MY_WALLETS_LABELS_KEY, JSON.stringify(walletLabels || {}));
      });

      myWalletBody.addEventListener('click', async (ev) => {
        const btn = ev.target?.closest?.('[data-copy]');
        if (!btn) return;
        const addr = btn.getAttribute('data-copy');
        try {
          await navigator.clipboard.writeText(addr);
          setHint(`Copied ${shortAddr(addr)}`, 'ok');
        } catch {}
      });

      launchInput.addEventListener('change', () => {
        const ms = launchInput.value ? new Date(launchInput.value).getTime() : NaN;
        if (Number.isFinite(ms) && ms > 0) {
          launchStartSec = Math.floor(ms / 1000);
          launchDisplayBtn.textContent = formatLocalDisplayFromSeconds(launchStartSec);
        }
        applyLaunchStartChange(true);
      });

      launchDisplayBtn.addEventListener('click', () => {
        openLaunchModal();
      });

      setNowBtn.addEventListener('click', () => {
        const nowSec = Math.floor(Date.now() / 1000);
        setLaunchInputBySeconds(nowSec);
        applyLaunchStartChange(true);
        setHint('已设置为当前时间。', 'ok');
      });

      launchBackdrop.addEventListener('click', () => closeLaunchModal());
      launchCloseBtn.addEventListener('click', () => closeLaunchModal());
      launchCancelBtn.addEventListener('click', () => closeLaunchModal());
      launchConfirmBtn.addEventListener('click', () => {
        const sec = Math.floor(getPickerSelectedDate().getTime() / 1000);
        setLaunchInputBySeconds(sec);
        closeLaunchModal();
        applyLaunchStartChange(true);
      });
      document.addEventListener('keydown', (ev) => {
        if (ev.key === 'Escape' && !launchModal.classList.contains('hidden')) {
          closeLaunchModal();
        }
      });

      bindWheel(wheelDate, 'date', 7);
      bindWheel(wheelHour, 'hour', 24);
      bindWheel(wheelMinute, 'minute', pickerState.minuteOptions.length);

      function connectEvents() {
        if (eventSource) {
          try { eventSource.close(); } catch {}
          eventSource = null;
        }
        eventSource = new EventSource('/api/events');
        eventSource.addEventListener('connected', () => {
          setHint('实时流已连接。', 'ok');
        });
        eventSource.addEventListener('update', (ev) => {
          const p = JSON.parse(ev.data);
          renderSnapshot(p.snapshot);
        });
        eventSource.addEventListener('signal', (ev) => {
          const p = JSON.parse(ev.data);
          flashUntil = Date.now() + 10000;
          renderSnapshot(p.snapshot);
        });
        eventSource.onerror = () => {
          statusPill.textContent = 'Status: disconnected | Block: -';
          transferPill.textContent = 'Transfers: disconnected';
          setHint('实时流断开，正在重连...', 'warn');
          try { eventSource.close(); } catch {}
          eventSource = null;
          clearTimeout(sseRetryTimer);
          sseRetryTimer = setTimeout(connectEvents, 2500);
        };
      }

      initLaunchStartInput();
      applyLaunchStartChange(true);
      const savedToken = localStorage.getItem(LS_TOKEN_KEY);
      const savedWallet = localStorage.getItem(LS_WALLET_KEY);
      const savedMyWallets = localStorage.getItem(LS_MY_WALLETS_KEY);
      const savedWalletLabels = localStorage.getItem(LS_MY_WALLETS_LABELS_KEY);
      const savedFromBlock = localStorage.getItem(LS_MY_FROM_BLOCK_KEY);
      if (savedToken) tokenInput.value = savedToken;
      if (savedWallet) walletInput.value = savedWallet;
      if (savedFromBlock) myWalletFromBlockInput.value = savedFromBlock;
      if (savedMyWallets) {
        try {
          myWallets = JSON.parse(savedMyWallets) || [];
        } catch {
          myWallets = [];
        }
      } else {
        myWallets = [];
      }
      if (savedWalletLabels) {
        try {
          walletLabels = JSON.parse(savedWalletLabels) || {};
        } catch {
          walletLabels = {};
        }
      } else {
        walletLabels = {};
      }
      syncWalletLabelMap();
      myWalletsInput.value = '';
      renderMyWalletTags();
      applyMyWalletsRuntime(false);
      connectEvents();

      fetch('/api/status').then((r) => r.json()).then((d) => {
        renderSnapshot(d.snapshot);
      }).catch(() => {
        setHint('获取初始状态失败，请检查后端服务。', 'err');
      });

      window.addEventListener('beforeunload', () => {
        if (eventSource) {
          try { eventSource.close(); } catch {}
        }
      });
    </script>
  </body>
</html>







